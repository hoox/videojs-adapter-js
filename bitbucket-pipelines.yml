# Check our guides at https://confluence.atlassian.com/x/VYk8Lw for more examples.
# Only use spaces to indent your .yml configuration.

# You can specify a custom docker image from Docker Hub as your build environment.
image: node:6

pipelines:
  default:
    - step:
        script: # Modify the commands below to build your repository.
          - npm install
          - npm test
          - if [ $? -eq 0 ]; then
          - npm run deployable
          - mkdir -p ~/.ssh
          - echo $QA_KNOWN_HOSTS >> ~/.ssh/known_hosts
          - (umask 077; echo $QA_SSH_KEY | base64 --decode > ~/.ssh/id_rsa)
          - scp -r deploy/last-build/* nicedeployer@qa-smartplugin.youbora.com:/home/nicedeployer/qa/catalog/v6/js/
          - fi

  tags:
    '*':
      - step:
          script:
            - npm install
            - npm test
            - if [ $? -eq 0 ]; then
            - npm run deployable
            - mkdir -p ~/.ssh
            - echo $QA_KNOWN_HOSTS >> ~/.ssh/known_hosts
            - (umask 077; echo $QA_SSH_KEY | base64 --decode > ~/.ssh/id_rsa)
            - scp -r deploy/version/* nicedeployer@qa-smartplugin.youbora.com:/home/nicedeployer/qa/catalog/v6/js/
            - fi

  custom: # Pipelines that are triggered manually
    deploy-to-prod:
      - step:
          script:
            - npm install
            - npm test
            - if [ $? -eq 0 ]; then
            - npm run deployable
            - apt-get update
            - apt-get -y install awscli
            - mkdir ~/.aws
            - echo "[default]" >> ~/.aws/credentials
            - echo "aws_access_key_id="$AWS_ACCESS_KEY_ID >>  ~/.aws/credentials
            - echo "aws_secret_access_key="$AWS_SECRET_ACCESS_KEY >>  ~/.aws/credentials
            - echo "[default]" >> ~/.aws/config
            - echo "region="$AWS_DEFAULT_REGION >> ~/.aws/config
            - echo "output=json" >> ~/.aws/config
            - aws s3 cp deploy/version/ s3://youbora-smartplugins/v6/js/ --recursive --acl=public-read
            - fi
